<div>
	<h1>スポット登録</h1>
</div>

<div class="flash_area">
	<%= flash[:notice] %>
	<%= flash[:warning] %>
</div>

<script src="https://maps.google.com/maps/api/js?v=3.exp&amp;key=AIzaSyDSm9JoN7yTni_Q6NOHxFPl9WxiGKn5J9U&amp;language=ja&amp;libraries=places"></script>

<div id="map-content" class="container-fluid mp0">
	<!-- 検索バー -->
	<div id="menu" style="width: 270px; height: 100px;">
		<div style="margin-top:20px">
			<span>登録したいスポット名を検索してください
			<div class="input-group">
				<input type="text" id="find-place-query" class="form-control" placeholder="スポット名 (例: 清水寺)">
				<button id="find-place-query-button" class="" type="button">検索</button>
			</div>
			<textarea id="result-area" style="width:100%; height:100px;font-size:.85em;" wrap="off"></textarea>
			</span>
		</div>
		<div class="spotform">
			<%= image_tag("no_spotimage.jpg", :size => "350x200") %>
			<!-- local:trueを外すと、remote:trueになる -->
			<%= form_with model: @spot, local: true  do |f| %>
			  <%= f.file_field :spotimage %><br>
			<table>
			  <tr>
			  	<th align="right"><label>名称&nbsp;</label></th>
			  	<th><%= f.text_field :name, id: "s_name", class: "spotinput" %></th>
			  </tr>
			   <tr>
			  	<th align="right"><label>詳細情報&nbsp;</label></th>
			  	<th><%= f.text_field :description, class: "spotinput" %></th>
			  </tr>
			   <tr>
			  	<th align="right"><label>住所&nbsp;</label></th>
			  	<th><%= f.text_field :address, id: "s_address", class: "spotinput" %></th>
			  </tr>
			   <tr>
			  	<th align="right"><label>ホームページのURL&nbsp;</label></th>
			  	<th><%= f.text_field :url, class: "s_web spotinput"%></th>
			  </tr>
  			   <tr>
			  	<th align="right"><label>カテゴリ&nbsp;</label></th>
			  	<th><%= f.collection_select :category_id, Category.all, :id, :category_name, { include_blank: true}, class: "spotinput" %></th>
			  </tr>
			</table>
			<%= f.submit '登録', class: "spotsubmit" %>
			<% end %>
		</div>
	</div>

	<!-- マップ表示 -->
	<div id="map"></div>
</div>

<style>
	.spotsubmit{

	}
	#find-place-query-button{
		padding: 3px;
	}

	.spotinput{
		width: 350px;
		height: 20px;
	}
	.spotform{
		height: 500px;
		width: 300px;
		display: block;
	}

	#map-content{
		height: 500px;
		width: 100%;
		white-space: nowrap;
		margin-bottom: 100px;
		padding-left: 10%;
	}

	#find-place-query{
		height: 20px;
	}

	#map{
		height: 100%;
		width: 500px;
		/*float: right;*/
		/*margin-right: 100px;*/
		display: inline-block;
		/*white-space: nowrap;*/
	}

	#menu{
		height: 100%;
		width: 300px;
		margin-right: 20%;
		/*float: left;*/
		display: inline-block;
		/*white-space: nowrap;*/
	}

	#result-area{

	}
</style>

<script>
$(function() {
	var _map = null;
	var _center = new google.maps.LatLng(34.985849, 135.75876670000002);
	var _zoom = 14;
	var _markerGeo = null;
	// var _menuWidth = 100;
	var _placesService = null;
	var _markers = [];

	// 地図の初期化
	var initMap = function() {
		_map = new google.maps.Map(document.getElementById("map"), {
			zoom : _zoom,
			center: _center,
			mayTypeId: google.maps.MapTypeId.ROADMAP,
			mapTypeControlOptions: {
			    position: google.maps.ControlPosition.BOTTOM_CENTER
			}
		});
		_placesService = new google.maps.places.PlacesService(_map);
	};



	// スポット検索
	var findPlaceFromQuery = function() {
		clearMarkers();
		_placesService.findPlaceFromQuery({
			query: $('#find-place-query').val(),
			fields: ['name', 'formatted_address', 'geometry', 'place_id']
		}, function(results, status) {
			console.log(results);

			// 結果を返す部分
			$('#result-area').val(JSON.stringify(results, null, '\t'));

 			$('#s_name').val(results[0].name);

			// var addr = results[0].formatted_address.replace(/日本/g , "");
			// alert(1);
 			$('#s_address').val(results[0].formatted_address.replace(/日本、/g , ""));

			if (status == google.maps.places.PlacesServiceStatus.OK) {
				for (var i = 0; i < results.length; i++) {
					var place = results[i];
					createMarker(place);
					_map.setCenter(place.geometry.location);
				}
			} else {
				alert('失敗しました。' + status);
			}
		});
	};




	// 詳細情報検索
	var placeDetails = function() {
		clearMarkers();
		_placesService.getDetails({
			placeId: $('#place-details').val(),
			fields: ['website']
		}, function(place, status) {
			console.log(place);
			$('#result-area').val(JSON.stringify(place, null, '\t'));
			// if (status == google.maps.places.PlacesServiceStatus.OK) {
			// 	createMarker(place);
			// } else {
			// 	alert('失敗しました。' + status);
			// }
		});
	};

	var clearMarkers = function() {
		$.each(_markers, function(i, marker) {
			marker.setMap(null);
		});
		_markers = [];
	};

	var createMarker = function(place) {
		var marker = new google.maps.Marker({
			map: _map,
			position: place.geometry.location,
			title: place.name
		});
		_markers.push(marker);
	};

	// ジオコードを実行し、地図を移動
	var geocode = function(address) {
		var geocoder = new google.maps.Geocoder();
		geocoder.geocode({
			address: address
		}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				_map.setCenter(results[0].geometry.location);
				if (_markerGeo == null) {
					_markerGeo = new google.maps.Marker({
						map: _map,
						position: results[0].geometry.location
					});
				} else {
					_markerGeo.setPosition(results[0].geometry.location);
				}
			}
		});
	};
	// 起動時の処理
	$(window).on('load', function() {
		initMap();
		$('#find-place-query-button').on('click', findPlaceFromQuery);
	});
});
</script>




<!-- プレビュー機能 -->
<script>
// 	$(document).on('turbolinks:load', function() {

//   $('#item_images').on('change',function(e){
//     var files = e.target.files;
//     var d = (new $.Deferred()).resolve();
//     $.each(files,function(i,file){
//       d = d.then(function(){return previewImage(file)});
//     });
//   })

//   var previewImage = function(imageFile){
//     var reader = new FileReader();
//     var img = new Image();
//     var def =$.Deferred();
//     reader.onload = function(e){
//       $('.images_field').append(img);
//       img.src = e.target.result;
//       def.resolve(img);
//     };
//     reader.readAsDataURL(imageFile);
//     return def.promise();
//   }
// })
</script>